# Enhanced Username Handling

This document describes the enhanced username handling feature that ensures usernames sent to VPN panels (especially Marzneshin) are always within safe length limits.

## Overview

When users (via Telegram bot or UI) supply a desired username, the system now treats that value strictly as a PREFIX and generates a unique, sanitized panel username. This solves issues caused by excessively long usernames generated by bots.

## How It Works

### Username Generation Flow

1. User provides a requested username (e.g., `ali` or a long bot-generated name)
2. The `UsernameGenerator` service sanitizes and truncates the username
3. A random suffix is appended to ensure uniqueness
4. The final panel username is: `<sanitized_prefix>_<shortSuffix>`

### Example

| Original Username | Sanitized Prefix | Panel Username |
|-------------------|------------------|----------------|
| `ali` | `ali` | `ali_abc123` |
| `Test@User!123` | `testuser123` | `testuser123_xyz456` |
| `very_long_telegram_username_from_bot` | `verylonguser` | `verylonguser_def789` |
| `علی` (Persian) | `user` | `user_ghi012` |

## Configuration

### Environment Variables

The following environment variables can be set to customize username generation:

| Variable | Default | Description |
|----------|---------|-------------|
| `USERNAME_PREFIX_MAX_LEN` | 12 | Maximum length for the sanitized prefix |
| `USERNAME_SUFFIX_LEN` | 6 | Length of the random suffix |
| `USERNAME_ALLOWED_CHARS_REGEX` | `/[^a-zA-Z0-9]/` | Regex pattern for characters to strip |
| `USERNAME_FALLBACK_PREFIX` | `user` | Prefix used when sanitization results in empty string |
| `USERNAME_MAX_TOTAL_LEN` | 20 | Maximum total length for panel usernames |
| `USERNAME_COLLISION_RETRY_LIMIT` | 5 | Number of collision retry attempts |

### Config File

Configuration is stored in `config/username.php`. You can publish and modify this file to customize behavior.

## Database Schema

Two new columns have been added to the `reseller_configs` table:

| Column | Type | Description |
|--------|------|-------------|
| `username_prefix` | VARCHAR(50) | The original/sanitized username prefix (displayed to users) |
| `panel_username` | VARCHAR(50) | The actual username sent to the panel |

### Migration

The migration `2025_11_29_130000_add_username_prefix_and_panel_username_to_reseller_configs_table.php` handles:

1. Adding the new columns
2. Creating indexes for efficient lookups
3. Migrating existing data (populating `panel_username` from `external_username` and extracting `username_prefix`)

## API Changes

### Response Format

API responses now expose the display username (prefix) instead of the full panel username:

```json
{
  "data": {
    "id": 123,
    "username": "ali",
    "name": "ali",
    "subscription_url": "https://...",
    "traffic_limit_bytes": 10737418240,
    ...
  }
}
```

### Lookup Flexibility

API endpoints that fetch configs by username now accept:
- The original prefix
- The full panel username
- The `external_username` (for backward compatibility)

Example: All of these will find the same config:
- `GET /api/configs/ali`
- `GET /api/configs/ali_abc123`

## Model Accessors

The `ResellerConfig` model includes new accessor methods:

```php
// Get the display username (shown to users)
$config->display_username; // "ali"

// Get the actual panel username
$config->panel_username; // "ali_abc123"

// Get effective username for panel API calls
$config->getEffectivePanelUsername(); // "ali_abc123"
```

## Query Scopes

New query scopes for searching configs:

```php
// Find by username prefix
ResellerConfig::byUsernamePrefix('ali')->get();

// Find by exact panel username
ResellerConfig::byPanelUsername('ali_abc123')->first();
```

## Collision Handling

The system handles username collisions with the following strategy:

1. Generate random suffix (base36 characters)
2. If collision detected, regenerate suffix
3. Retry up to `USERNAME_COLLISION_RETRY_LIMIT` times
4. If all random attempts fail, fall back to numeric increment (0001, 0002, etc.)

## Backward Compatibility

- The `external_username` field is still populated (same value as `panel_username`)
- API responses include both `username` and `name` fields (both contain the display username)
- Existing configs will have `panel_username` populated from `external_username` during migration

## Usage in Code

### Creating a New Config

```php
use App\Services\UsernameGenerator;

$generator = new UsernameGenerator();
$usernameData = $generator->generatePanelUsername(
    'requested_username',
    $generator->createDatabaseExistsChecker()
);

// $usernameData contains:
// [
//     'panel_username' => 'requestedus_abc123',
//     'username_prefix' => 'requestedus',
//     'original_username' => 'requested_username'
// ]
```

### In ResellerProvisioner

```php
$provisioner = new ResellerProvisioner();
$usernameData = $provisioner->generateEnhancedUsername('requested_username');
```

## Testing

Unit tests for the UsernameGenerator are available in `tests/Unit/UsernameGeneratorTest.php`.

Run tests with:

```bash
php artisan test --filter=UsernameGeneratorTest
```

## Security Considerations

- Full panel usernames are not exposed to end users
- Original requested usernames are sanitized to prevent injection
- Username generation is logged for audit purposes (without sensitive data)
